@{
    ViewData["Title"] = "Setup - Khởi tạo Dữ liệu Demo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-database"></i>
                        Setup - Khởi tạo Dữ liệu Demo
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                        <li class="breadcrumb-item active">Cài đặt</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Status Cards -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                Trạng thái Dữ liệu Hiện tại
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-primary" id="refreshStatus">
                                    <i class="fas fa-sync-alt"></i>
                                    Làm mới
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row" id="statusCards">
                                <!-- Status cards will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Setup Modules -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cogs"></i>
                                Modules Khởi tạo Dữ liệu
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-success" id="setupAll">
                                    <i class="fas fa-database"></i>
                                    Setup Tất cả
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" id="clearAll">
                                    <i class="fas fa-trash"></i>
                                    Xóa Tất cả
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row" id="setupModules">
                                <!-- Setup modules will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Modal -->
            <div class="modal fade" id="progressModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                <i class="fas fa-spinner fa-spin"></i>
                                Đang khởi tạo dữ liệu...
                            </h4>
                        </div>
                        <div class="modal-body">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progressBar">
                                    0%
                                </div>
                            </div>
                            <div id="progressText">
                                Bắt đầu khởi tạo dữ liệu...
                            </div>
                            <div id="progressDetails" class="mt-3">
                                <!-- Progress details will be shown here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal" id="cancelSetup">
                                Hủy bỏ
                            </button>
                        </div>
                    </div>
                </div>
    </section>

<!-- Setup Script -->

<style>
    .setup-module {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .setup-module:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .setup-module.setup-success {
        border-left: 4px solid #28a745;
        background-color: #d4edda;
    }
    
    .setup-module.setup-error {
        border-left: 4px solid #dc3545;
        background-color: #f8d7da;
    }
    
    .setup-module.setup-progress {
        border-left: 4px solid #007bff;
        background-color: #cce7ff;
    }
    
    .status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .status-card:hover {
        transform: scale(1.05);
    }
    
    .status-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .status-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
    
    .progress-step {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        background: #f8f9fa;
        border-left: 3px solid #007bff;
    }
    
    .progress-step.success {
        border-left-color: #28a745;
        background: #d4edda;
    }
    
    .progress-step.error {
        border-left-color: #dc3545;
        background: #f8d7da;
    }
</style>

@section Scripts {
<script>
$(document).ready(function() {
    // Check if required libraries are loaded
    if (typeof Swal === 'undefined') {
        console.error('SweetAlert2 not loaded');
        return;
    }
    
    console.log('Setup page initialized');
    
    // Load setup modules and status on page load
    loadSetupModules();
    loadDataStatus();
    
    // Bind events
    $('#refreshStatus').click(function() {
        loadDataStatus();
    });
    
    $('#setupAll').click(function() {
        setupAllModules();
    });
    
    $('#clearAll').click(function() {
        clearAllData();
    });
    
    // Load setup modules
    function loadSetupModules() {
        $.ajax({
            url: '/Setup/GetSetupModules',
            type: 'GET',
            success: function(response) {
                if (response && response.length > 0) {
                    displaySetupModules(response);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading setup modules:', error);
                $('#setupModules').html('<div class="col-12"><div class="alert alert-danger">Lỗi khi tải danh sách modules: ' + error + '</div></div>');
            }
        });
    }
    
    // Display setup modules
    function displaySetupModules(modules) {
        var html = '';
        var currentPhase = '';
        
        modules.forEach(function(module) {
            if (module.phase !== currentPhase) {
                if (currentPhase !== '') {
                    html += '</div></div>'; // Close previous phase
                }
                html += '<div class="col-12 mb-4">';
                html += '<h5 class="text-primary"><i class="fas fa-layer-group"></i> ' + module.phase + '</h5>';
                html += '<p class="text-muted small">' + module.phaseDescription + '</p>';
                html += '<div class="row">';
                currentPhase = module.phase;
            }
            
            html += '<div class="col-md-4 col-lg-3 mb-3">';
            html += '<div class="card setup-module" data-module="' + module.id + '">';
            html += '<div class="card-body text-center">';
            html += '<i class="' + module.icon + ' fa-2x text-primary mb-2"></i>';
            html += '<h6 class="card-title">' + module.name + '</h6>';
            html += '<p class="card-text small text-muted">' + module.description + '</p>';
            html += '<button class="btn btn-sm btn-outline-primary setup-module-btn" data-module="' + module.id + '">';
            html += '<i class="fas fa-play"></i> Tạo dữ liệu';
            html += '</button>';
            html += '</div></div></div>';
        });
        
        if (currentPhase !== '') {
            html += '</div></div>'; // Close last phase
        }
        
        $('#setupModules').html(html);
        
        // Bind module setup events
        $('.setup-module-btn').click(function() {
            var moduleId = $(this).data('module');
            setupModule(moduleId);
        });
    }
    
    // Load data status
    function loadDataStatus() {
        $.ajax({
            url: '/Setup/CheckDataStatus',
            type: 'GET',
            success: function(response) {
                if (response.success && response.data) {
                    displayDataStatus(response.data);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading data status:', error);
                $('#statusCards').html('<div class="col-12"><div class="alert alert-danger">Lỗi khi tải trạng thái dữ liệu</div></div>');
            }
        });
    }
    
    // Display data status
    function displayDataStatus(status) {
        var html = '';
        var statusItems = [
            { key: 'customers', label: 'Khách hàng', icon: 'fas fa-users' },
            { key: 'vehicles', label: 'Xe', icon: 'fas fa-car' },
            { key: 'employees', label: 'Nhân viên', icon: 'fas fa-user-tie' },
            { key: 'services', label: 'Dịch vụ', icon: 'fas fa-tools' },
            { key: 'parts', label: 'Phụ tùng', icon: 'fas fa-cogs' },
            { key: 'suppliers', label: 'Nhà cung cấp', icon: 'fas fa-truck' },
            { key: 'inspections', label: 'Kiểm tra xe', icon: 'fas fa-search' },
            { key: 'quotations', label: 'Báo giá', icon: 'fas fa-file-invoice-dollar' },
            { key: 'orders', label: 'Đơn hàng', icon: 'fas fa-clipboard-list' },
            { key: 'payments', label: 'Thanh toán', icon: 'fas fa-credit-card' },
            { key: 'appointments', label: 'Lịch hẹn', icon: 'fas fa-calendar-alt' }
        ];
        
        statusItems.forEach(function(item) {
            var count = status[item.key] || 0;
            html += '<div class="col-md-3 col-sm-6 mb-3">';
            html += '<div class="status-card">';
            html += '<div class="status-number">' + count + '</div>';
            html += '<div class="status-label">';
            html += '<i class="' + item.icon + '"></i> ' + item.label;
            html += '</div></div></div>';
        });
        
        $('#statusCards').html(html);
    }
    
    // Setup single module
    function setupModule(moduleId) {
        // Call API through Web Application's SetupController which will proxy to API
        $.ajax({
            url: '@Url.Action("CreateModule", "Setup")?moduleId=' + moduleId,
            type: 'POST',
            beforeSend: function() {
                $('.setup-module[data-module="' + moduleId + '"]').addClass('setup-progress');
                $('.setup-module-btn[data-module="' + moduleId + '"]').prop('disabled', true);
            },
            success: function(response) {
                if (response.success) {
                    $('.setup-module[data-module="' + moduleId + '"]').removeClass('setup-progress').addClass('setup-success');
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Tạo dữ liệu ' + moduleId + ' thành công: ' + response.message,
                        timer: 3000,
                        showConfirmButton: false
                    });
                    loadDataStatus(); // Refresh status
                } else {
                    $('.setup-module[data-module="' + moduleId + '"]').removeClass('setup-progress').addClass('setup-error');
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Lỗi tạo dữ liệu ' + moduleId + ': ' + response.message
                    });
                }
            },
            error: function(xhr, status, error) {
                $('.setup-module[data-module="' + moduleId + '"]').removeClass('setup-progress').addClass('setup-error');
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Lỗi tạo dữ liệu ' + moduleId
                });
            },
            complete: function() {
                $('.setup-module-btn[data-module="' + moduleId + '"]').prop('disabled', false);
            }
        });
    }
    
    // Setup all modules
    function setupAllModules() {
        if (!confirm('Bạn có chắc muốn tạo tất cả dữ liệu demo?')) {
            return;
        }
        
        $('#progressModal').modal('show');
        var modules = ['customers', 'employees', 'suppliers', 'vehicles', 'parts', 'services', 'inspections', 'quotations', 'orders', 'payments', 'appointments'];
        var currentIndex = 0;
        
        function setupNextModule() {
            if (currentIndex >= modules.length) {
                $('#progressModal').modal('hide');
                Swal.fire({
                    icon: 'success',
                    title: 'Hoàn thành!',
                    text: 'Đã tạo tất cả dữ liệu demo thành công!',
                    timer: 3000,
                    showConfirmButton: false
                });
                loadDataStatus();
                loadSetupModules();
                return;
            }
            
            var moduleId = modules[currentIndex];
            var progress = Math.round((currentIndex / modules.length) * 100);
            
            $('#progressBar').css('width', progress + '%').text(progress + '%');
            $('#progressText').text('Đang tạo dữ liệu: ' + moduleId);
            
            $.ajax({
                url: '@Url.Action("CreateModule", "Setup")?moduleId=' + moduleId,
                type: 'POST',
                success: function(response) {
                    var statusClass = response.success ? 'success' : 'error';
                    var statusText = response.success ? 'Thành công' : 'Lỗi: ' + response.message;
                    $('#progressDetails').append('<div class="progress-step ' + statusClass + '">' + moduleId + ': ' + statusText + '</div>');
                    currentIndex++;
                    setTimeout(setupNextModule, 1000);
                },
                error: function() {
                    $('#progressDetails').append('<div class="progress-step error">' + moduleId + ': Lỗi kết nối</div>');
                    currentIndex++;
                    setTimeout(setupNextModule, 1000);
                }
            });
        }
        
        setupNextModule();
    }
    
    // Clear all data
    function clearAllData() {
        if (!confirm('Bạn có chắc muốn XÓA TẤT CẢ dữ liệu? Hành động này không thể hoàn tác!')) {
            return;
        }
        
        $.ajax({
            url: '/Setup/ClearAllData',
            type: 'POST',
            beforeSend: function() {
                $('#clearAll').prop('disabled', true);
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: 'Đã xóa tất cả dữ liệu thành công!',
                        timer: 3000,
                        showConfirmButton: false
                    });
                    loadDataStatus();
                    loadSetupModules();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Lỗi xóa dữ liệu: ' + response.message
                    });
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Lỗi xóa dữ liệu'
                });
            },
            complete: function() {
                $('#clearAll').prop('disabled', false);
            }
        });
    }
});
</script>
}