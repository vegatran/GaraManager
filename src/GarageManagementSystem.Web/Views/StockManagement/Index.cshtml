@{
    ViewData["Title"] = "Quản Lý Nhập Xuất Kho";
}

@Html.AntiForgeryToken()

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Quản Lý Nhập Xuất Kho</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang Chủ</a></li>
                    <li class="breadcrumb-item active">Nhập Xuất Kho</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Danh Sách Giao Dịch Kho</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#createTransactionModal">
                                <i class="fas fa-plus"></i> Thêm Giao Dịch Mới
                            </button>
                            <button type="button" class="btn btn-info btn-sm mr-1" id="downloadTemplateBtn">
                                <i class="fas fa-download"></i> Tải Template
                            </button>
                            <button type="button" class="btn btn-success btn-sm" data-toggle="modal" data-target="#importModal">
                                <i class="fas fa-file-import"></i> Import Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table id="stockTransactionsTable" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Mã Giao Dịch</th>
                                    <th>Phụ Tùng</th>
                                    <th>Loại Giao Dịch</th>
                                    <th>Số Lượng</th>
                                    <th>Tồn Trước</th>
                                    <th>Tồn Sau</th>
                                    <th>Đơn Giá</th>
                                    <th>Thành Tiền</th>
                                    <th>Ngày Giao Dịch</th>
                                    <th>Ghi Chú</th>
                                    <th>Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Create Transaction Modal -->
<div class="modal fade" id="createTransactionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Thêm Giao Dịch Kho Mới</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="createTransactionForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="partId">Phụ Tùng <span class="text-danger">*</span></label>
                                <select class="form-control form-control-sm select2" id="partId" name="PartId" required>
                                    <option value="">-- Chọn phụ tùng --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="transactionType">Loại Giao Dịch <span class="text-danger">*</span></label>
                                <select class="form-control form-control-sm" id="transactionType" name="TransactionType" required>
                                    <option value="">-- Chọn loại giao dịch --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quantity">Số Lượng <span class="text-danger">*</span></label>
                                <input type="number" class="form-control form-control-sm" id="quantity" name="Quantity" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="unitPrice">Đơn Giá (VNĐ) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control form-control-sm" id="unitPrice" name="UnitPrice" min="0" step="1000" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="supplierId">Nhà Cung Cấp</label>
                                <select class="form-control form-control-sm select2" id="supplierId" name="SupplierId">
                                    <option value="">-- Chọn nhà cung cấp --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="referenceNumber">Số Tham Chiếu</label>
                                <input type="text" class="form-control form-control-sm" id="referenceNumber" name="ReferenceNumber" maxlength="100">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Ghi Chú</label>
                        <textarea class="form-control form-control-sm" id="notes" name="Notes" rows="3" maxlength="1000"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary btn-sm">Tạo Giao Dịch</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Opening Balance Modal -->
<div class="modal fade" id="importModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Import Excel - Tồn Kho</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="importForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h5><i class="icon fas fa-info"></i> Hướng dẫn Import Excel</h5>
                        <p>Upload file Excel với cấu trúc:</p>
                        <ul>
                            <li><strong>Mã Hiệu</strong>: Mã phụ tùng (bắt buộc)</li>
                            <li><strong>Tên VTTH</strong>: Tên vật tư thiết bị hàng hóa</li>
                            <li><strong>Đơn vị</strong>: Đơn vị tính (CÁI, Chiếc, Bộ, Kg...)</li>
                            <li><strong>Tồn đầu kỳ</strong>: Số lượng và giá trị tồn kho</li>
                            <li><strong>Nhập/Xuất trong kỳ</strong>: Giao dịch nhập xuất</li>
                            <li><strong>Đơn giá</strong>: Giá đơn vị (VNĐ)</li>
                        </ul>
                        <p><strong>Lưu ý:</strong> Tải template mẫu để đảm bảo đúng định dạng.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="excelFile">Chọn File Excel</label>
                        <div class="input-group">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input form-control-sm" id="excelFile" name="excelFile" accept=".xlsx,.xls">
                                <label class="custom-file-label" for="excelFile">Chọn file Excel...</label>
                            </div>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-outline-info btn-sm" id="validateFileBtn">
                                    <i class="fas fa-check"></i> Validate
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">Hỗ trợ file .xlsx, .xls (tối đa 10MB)</small>
                    </div>

                    <!-- Preview Results -->
                    <div id="validationResults" class="mt-3" style="display: none;">
                        <h6><i class="fas fa-clipboard-check"></i> Kết Quả Validate</h6>
                        <div id="validationContent"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="importProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Đang import dữ liệu...</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success btn-sm">Import Dữ Liệu</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize DataTable
            var table = $('#stockTransactionsTable').DataTable({
                "processing": true,
                "serverSide": false,
                "ajax": {
                    "url": "@Url.Action("GetStockTransactions", "StockManagement")",
                    "type": "GET"
                },
                "columns": [
                    { "data": "transactionNumber" },
                    { "data": "partName" },
                    { "data": "transactionType" },
                    { "data": "quantity", "className": "text-center" },
                    { "data": "quantityBefore", "className": "text-center" },
                    { "data": "quantityAfter", "className": "text-center" },
                    { "data": "unitPrice", "className": "text-right" },
                    { "data": "totalAmount", "className": "text-right" },
                    { "data": "transactionDate" },
                    { "data": "notes" },
                    {
                        "data": null,
                        "orderable": false,
                        "className": "text-center",
                        "render": function(data, type, row) {
                            return `
                                <button class="btn btn-info btn-sm" onclick="viewTransaction(${row.id})" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;
                        }
                    }
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json"
                },
                "responsive": true,
                "autoWidth": false,
                "pageLength": 25
            });

            // Load dropdowns
            loadDropdowns();

            // Create transaction form
            $('#createTransactionForm').on('submit', function(e) {
                e.preventDefault();
                createStockTransaction();
            });

            // Import form
            $('#importForm').on('submit', function(e) {
                e.preventDefault();
                importOpeningBalance();
            });
        });

        function loadDropdowns() {
            // Load parts
            $.get('@Url.Action("GetAvailableParts", "StockManagement")', function(response) {
                if (response.success) {
                    var partSelect = $('#partId');
                    partSelect.empty().append('<option value="">-- Chọn phụ tùng --</option>');
                    $.each(response.data, function(index, item) {
                        partSelect.append(`<option value="${item.id}">${item.text}</option>`);
                    });
                    partSelect.select2({
                        placeholder: "-- Chọn phụ tùng --",
                        allowClear: true
                    });
                }
            });

            // Load transaction types
            $.get('@Url.Action("GetTransactionTypes", "StockManagement")', function(response) {
                if (response.success) {
                    var typeSelect = $('#transactionType');
                    typeSelect.empty().append('<option value="">-- Chọn loại giao dịch --</option>');
                    $.each(response.data, function(index, item) {
                        typeSelect.append(`<option value="${item.id}">${item.text}</option>`);
                    });
                }
            });

            // Load suppliers
            $.get('@Url.Action("GetAvailableSuppliers", "StockManagement")', function(response) {
                if (response.success) {
                    var supplierSelect = $('#supplierId');
                    supplierSelect.empty().append('<option value="">-- Chọn nhà cung cấp --</option>');
                    $.each(response.data, function(index, item) {
                        supplierSelect.append(`<option value="${item.id}">${item.text}</option>`);
                    });
                    supplierSelect.select2({
                        placeholder: "-- Chọn nhà cung cấp --",
                        allowClear: true
                    });
                }
            });
        }

        function createStockTransaction() {
            var formData = {
                PartId: parseInt($('#partId').val()),
                TransactionType: $('#transactionType').val(),
                Quantity: parseInt($('#quantity').val()),
                UnitPrice: parseFloat($('#unitPrice').val()),
                SupplierId: $('#supplierId').val() ? parseInt($('#supplierId').val()) : null,
                ReferenceNumber: $('#referenceNumber').val(),
                Notes: $('#notes').val()
            };

            $.ajax({
                url: '@Url.Action("CreateStockTransaction", "StockManagement")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: response.message,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            $('#createTransactionModal').modal('hide');
                            $('#stockTransactionsTable').DataTable().ajax.reload();
                            $('#createTransactionForm')[0].reset();
                        });
                    } else {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi tạo giao dịch kho',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }

        function importOpeningBalance() {
            var importData = $('#importData').val();
            
            try {
                var parsedData = JSON.parse(importData);
                var request = {
                    Items: parsedData
                };

                $.ajax({
                    url: '@Url.Action("ImportOpeningBalance", "StockManagement")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(request),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                title: 'Thành công!',
                                text: response.message,
                                icon: 'success',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                $('#importModal').modal('hide');
                                $('#stockTransactionsTable').DataTable().ajax.reload();
                                $('#importData').val('');
                            });
                        } else {
                            Swal.fire({
                                title: 'Lỗi!',
                                text: response.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Có lỗi xảy ra khi import dữ liệu',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            } catch (e) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Dữ liệu JSON không hợp lệ: ' + e.message,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        function viewTransaction(id) {
            $.get('@Url.Action("GetStockTransaction", "StockManagement")/' + id, function(response) {
                if (response.success) {
                    var data = response.data;
                    var html = `
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Mã giao dịch:</strong> ${data.transactionNumber}<br>
                                <strong>Phụ tùng:</strong> ${data.partName || 'N/A'}<br>
                                <strong>Loại giao dịch:</strong> ${data.transactionTypeDisplay}<br>
                                <strong>Số lượng:</strong> ${data.quantity}
                            </div>
                            <div class="col-md-6">
                                <strong>Tồn trước:</strong> ${data.quantityBefore}<br>
                                <strong>Tồn sau:</strong> ${data.quantityAfter}<br>
                                <strong>Đơn giá:</strong> ${data.unitPrice.toLocaleString()} VNĐ<br>
                                <strong>Thành tiền:</strong> ${data.totalAmount.toLocaleString()} VNĐ
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <strong>Ngày giao dịch:</strong> ${new Date(data.transactionDate).toLocaleString('vi-VN')}<br>
                                <strong>Ghi chú:</strong> ${data.notes || 'Không có'}
                            </div>
                        </div>
                    `;
                    
                    Swal.fire({
                        title: 'Chi tiết giao dịch kho',
                        html: html,
                        icon: 'info',
                        confirmButtonText: 'Đóng'
                    });
                } else {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: response.message,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }
    </script>
}
